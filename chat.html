
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تقدير - مساعد ذكي لتقدير القوى العاملة التطوعية</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap');
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      direction: rtl;
    }

    .chat-container {
      width: 100%;
      max-width: 500px;
      height: 95vh;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 25px 20px;
      text-align: center;
      border-radius: 20px 20px 0 0;
    }

    .header-title {
      font-size: 1.8rem;
      font-weight: 900;
      margin-bottom: 5px;
    }

    .header-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 400;
    }

    .chat-box {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #f8fafc;
    }

    .message {
      padding: 15px 20px;
      border-radius: 18px;
      max-width: 85%;
      line-height: 1.6;
      word-wrap: break-word;
      font-size: 15px;
      animation: fadeIn 0.3s ease-in-out;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-bottom-left-radius: 5px;
    }

    .message.bot {
      align-self: flex-start;
      background: #ffffff;
      color: #2d3748;
      border-bottom-right-radius: 5px;
      border: 1px solid #e2e8f0;
    }

    .message.system {
      align-self: center;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white;
      text-align: center;
      font-weight: 600;
      max-width: 90%;
    }

    .input-area {
      display: flex;
      border-top: 1px solid #e5e7eb;
      background: #fff;
      padding: 15px;
      gap: 12px;
    }

    .input-area input {
      flex: 1;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      padding: 12px 20px;
      font-size: 15px;
      outline: none;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
    }

    .input-area input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-area button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 20px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      min-width: 80px;
    }

    .input-area button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .input-area button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .typing-indicator {
      display: none;
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 18px;
      padding: 15px 20px;
      margin-bottom: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #667eea;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
      30% { transform: scale(1.2); opacity: 1; }
    }

    .suggestion-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .suggestion-btn {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 15px;
      padding: 8px 15px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
      color: #4a5568;
    }

    .suggestion-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .results-table {
      background: #f8fafc;
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
      border: 1px solid #e2e8f0;
    }

    .results-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .results-row:last-child {
      border-bottom: none;
      font-weight: 600;
      background: #667eea;
      color: white;
      margin: 10px -15px -15px;
      padding: 12px 15px;
      border-radius: 0 0 10px 10px;
    }

    .welcome-message {
      text-align: center;
      color: #4a5568;
      padding: 20px;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .chat-container {
        height: 100vh;
        border-radius: 0;
        max-width: 100%;
      }
      
      .chat-header {
        border-radius: 0;
        padding: 20px;
      }
      
      .header-title {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-title">🧮 تقدير</div>
      <div class="header-subtitle">مساعد ذكي لتقدير القوى العاملة التطوعية</div>
    </div>

    <div id="chatBox" class="chat-box">
      <div class="message system">
        مرحباً بك في منصة تقدير! 👋
      </div>
      <div class="message bot">
        أهلاً وسهلاً! أنا مساعدك الذكي لتقدير القوى العاملة التطوعية. سأساعدك في حساب عدد المتطوعين والمنظمين والمشرفين والمسعفين وغيرهم من الكوادر المطلوبة لفعاليتك.
        
        <br><br>لنبدأ، أخبرني عن فعاليتك:
        
        <div class="suggestion-buttons">
          <button class="suggestion-btn" onclick="sendSuggestion('مؤتمر في الرياض')">مؤتمر في الرياض</button>
          <button class="suggestion-btn" onclick="sendSuggestion('مهرجان في جدة')">مهرجان في جدة</button>
          <button class="suggestion-btn" onclick="sendSuggestion('معرض تجاري')">معرض تجاري</button>
          <button class="suggestion-btn" onclick="sendSuggestion('فعالية رياضية')">فعالية رياضية</button>
        </div>
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="اكتب رسالتك هنا...">
      <button id="sendBtn">إرسال</button>
    </div>
  </div>

  <script>
    const sendBtn = document.getElementById("sendBtn");
    const userInput = document.getElementById("userInput");
    const chatBox = document.getElementById("chatBox");
    const typingIndicator = document.getElementById("typingIndicator");
    const API_KEY = "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";

    let conversationState = {
      step: 'initial',
      eventData: {},
      collectedInfo: {
        eventType: null,
        location: null,
        attendees: null,
        duration: null,
        buildings: null,
        area: null,
        workHours: null,
        complexity: null,
        budget: null
      }
    };

    // تقدير ذكي للقوى العاملة
    const systemPrompts = {
      systemMessage: `أنت مساعد ذكي متخصص في تقدير القوى العاملة التطوعية والموارد البشرية للفعاليات والمشاريع في المملكة العربية السعودية. 

مهمتك:
1. جمع المعلومات الأساسية عن الفعالية من المستخدم
2. تحليل البيانات وحساب التقديرات بناءً على المعايير المهنية
3. تقديم تقرير مفصل يشمل:
   - عدد المتطوعين المطلوب
   - عدد المنظمين والمشرفين
   - عدد المسعفين والأمن
   - عدد الموظفين الإداريين
   - التكلفة التقديرية
   - التوصيات والنصائح

المعلومات المطلوبة:
- نوع الفعالية (مؤتمر، مهرجان، معرض، ورشة، رياضية، ثقافية، خيرية)
- الموقع/المنطقة
- عدد الحضور المتوقع
- مدة الفعالية (أيام)
- عدد المباني/القاعات
- المساحة الإجمالية
- ساعات العمل اليومية
- مستوى التعقيد
- الميزانية التقديرية (اختياري)

معايير الحساب:
- نسبة المتطوعين للحضور: 3-8% حسب نوع الفعالية
- مشرف لكل 8-12 متطوع
- منسق لكل 3-4 مشرفين
- مسعف لكل 200-500 شخص حسب نوع الفعالية
- أمن: 1-2 لكل 100 شخص
- موظف استقبال: 1 لكل مدخل أو 200 شخص

اطرح الأسئلة بشكل تدريجي ومريح، واجعل المحادثة طبيعية وودية.`
    };

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      appendMessage("user", message);
      userInput.value = "";
      sendBtn.disabled = true;

      showTypingIndicator();

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: "gpt-4",
            messages: [
              { role: "system", content: systemPrompts.systemMessage },
              { role: "user", content: message }
            ],
            temperature: 0.7,
            max_tokens: 1500
          })
        });

        hideTypingIndicator();

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error.message);
        }

        const botReply = data.choices[0].message.content;
        appendMessage("bot", botReply);

      } catch (error) {
        hideTypingIndicator();
        // مباشرة إلى المحاكاة دون رسائل خطأ
        simulateResponse(message);
      } finally {
        sendBtn.disabled = false;
      }
    }

    function simulateResponse(userMessage) {
      const message = userMessage.toLowerCase();
      let response = "";
      
      // تحليل المعلومات من الرسالة
      extractInfoFromMessage(userMessage);
      
      // تحديد المرحلة التالية
      if (!conversationState.collectedInfo.eventType) {
        if (message.includes('مؤتمر')) {
          conversationState.collectedInfo.eventType = 'conference';
          response = "ممتاز! مؤتمر. 📋\n\nكم عدد الحضور المتوقع؟ (مثال: 500 شخص)";
        } else if (message.includes('مهرجان')) {
          conversationState.collectedInfo.eventType = 'festival';
          response = "رائع! مهرجان. 🎪\n\nكم عدد الحضور المتوقع؟ (مثال: 2000 شخص)";
        } else if (message.includes('معرض')) {
          conversationState.collectedInfo.eventType = 'exhibition';
          response = "عظيم! معرض. 🏢\n\nكم عدد الحضور المتوقع؟ (مثال: 1000 شخص)";
        } else if (message.includes('ورشة')) {
          conversationState.collectedInfo.eventType = 'workshop';
          response = "ممتاز! ورشة عمل. 🛠️\n\nكم عدد المشاركين المتوقع؟ (مثال: 100 شخص)";
        } else if (message.includes('رياض') || message.includes('ثقاف') || message.includes('خير')) {
          conversationState.collectedInfo.eventType = 'cultural';
          response = "رائع! فعالية ثقافية. 🎭\n\nكم عدد الحضور المتوقع؟";
        } else {
          response = "أهلاً وسهلاً! 😊\n\nما نوع الفعالية؟\n• مؤتمر\n• مهرجان\n• معرض\n• ورشة عمل\n• فعالية رياضية\n• فعالية ثقافية\n• فعالية خيرية";
        }
      } else if (!conversationState.collectedInfo.attendees) {
        const numbers = userMessage.match(/\d+/g);
        if (numbers) {
          conversationState.collectedInfo.attendees = parseInt(numbers[0]);
          response = `تمام! ${conversationState.collectedInfo.attendees} شخص. 👥\n\nأين ستقام الفعالية؟ (المدينة/المنطقة)`;
        } else {
          response = "لم أتمكن من فهم العدد. يرجى كتابة عدد الحضور بالأرقام (مثال: 500)";
        }
      } else if (!conversationState.collectedInfo.location) {
        conversationState.collectedInfo.location = userMessage;
        response = `ممتاز! في ${userMessage}. 📍\n\nكم يوم ستستمر الفعالية؟ (مثال: 3 أيام)`;
      } else if (!conversationState.collectedInfo.duration) {
        const numbers = userMessage.match(/\d+/g);
        if (numbers) {
          conversationState.collectedInfo.duration = parseInt(numbers[0]);
          response = `تمام! ${conversationState.collectedInfo.duration} أيام. ⏰\n\nكم عدد المباني/القاعات؟ (مثال: 2 مبنى)`;
        } else {
          response = "يرجى كتابة عدد الأيام بالأرقام (مثال: 3)";
        }
      } else if (!conversationState.collectedInfo.buildings) {
        const numbers = userMessage.match(/\d+/g);
        if (numbers) {
          conversationState.collectedInfo.buildings = parseInt(numbers[0]);
          response = `ممتاز! ${conversationState.collectedInfo.buildings} مبنى/قاعة. 🏢\n\nما هي المساحة الإجمالية تقريباً؟ (مثال: 5000 متر مربع)`;
        } else {
          response = "يرجى كتابة عدد المباني بالأرقام (مثال: 2)";
        }
      } else if (!conversationState.collectedInfo.area) {
        const numbers = userMessage.match(/\d+/g);
        if (numbers) {
          conversationState.collectedInfo.area = parseInt(numbers[0]);
          response = `تمام! ${conversationState.collectedInfo.area} متر مربع. 📐\n\nكم ساعة عمل يومياً؟ (مثال: 8 ساعات)`;
        } else {
          response = "يرجى كتابة المساحة بالأرقام (مثال: 5000)";
        }
      } else if (!conversationState.collectedInfo.workHours) {
        const numbers = userMessage.match(/\d+/g);
        if (numbers) {
          conversationState.collectedInfo.workHours = parseInt(numbers[0]);
          response = `ممتاز! ${conversationState.collectedInfo.workHours} ساعات يومياً. ⏱️\n\nما مستوى تعقيد الفعالية؟\n• بسيط\n• متوسط\n• معقد`;
        } else {
          response = "يرجى كتابة عدد ساعات العمل بالأرقام (مثال: 8)";
        }
      } else if (!conversationState.collectedInfo.complexity) {
        if (message.includes('بسيط')) {
          conversationState.collectedInfo.complexity = 'simple';
        } else if (message.includes('متوسط')) {
          conversationState.collectedInfo.complexity = 'medium';
        } else if (message.includes('معقد')) {
          conversationState.collectedInfo.complexity = 'complex';
        } else {
          response = "يرجى اختيار مستوى التعقيد:\n• بسيط\n• متوسط\n• معقد";
          appendMessage("bot", response);
          return;
        }
        
        // جمع كل المعلومات - إنشاء التحليل الكامل
        response = generateCompleteAnalysis();
      } else {
        // المستخدم يريد تعديل شيء
        response = handleModification(userMessage);
      }
      
      appendMessage("bot", response);
    }

    function extractInfoFromMessage(message) {
      // استخراج الأرقام والمعلومات من الرسالة
      const numbers = message.match(/\d+/g);
      if (numbers) {
        const num = parseInt(numbers[0]);
        
        // تحديد نوع الرقم بناءً على السياق
        if (message.includes('شخص') || message.includes('حضور') || message.includes('مشارك')) {
          if (!conversationState.collectedInfo.attendees) {
            conversationState.collectedInfo.attendees = num;
          }
        } else if (message.includes('يوم') || message.includes('أيام')) {
          if (!conversationState.collectedInfo.duration) {
            conversationState.collectedInfo.duration = num;
          }
        } else if (message.includes('مبنى') || message.includes('قاعة') || message.includes('صالة')) {
          if (!conversationState.collectedInfo.buildings) {
            conversationState.collectedInfo.buildings = num;
          }
        } else if (message.includes('متر') || message.includes('مساحة')) {
          if (!conversationState.collectedInfo.area) {
            conversationState.collectedInfo.area = num;
          }
        } else if (message.includes('ساعة') || message.includes('ساعات')) {
          if (!conversationState.collectedInfo.workHours) {
            conversationState.collectedInfo.workHours = num;
          }
        }
      }
    }

    function generateCompleteAnalysis() {
      const info = conversationState.collectedInfo;
      
      // حسابات متقدمة ودقيقة
      const eventMultipliers = {
        'conference': { base: 0.08, security: 0.003, medical: 0.002 },
        'festival': { base: 0.12, security: 0.008, medical: 0.004 },
        'exhibition': { base: 0.06, security: 0.004, medical: 0.002 },
        'workshop': { base: 0.05, security: 0.002, medical: 0.001 },
        'cultural': { base: 0.07, security: 0.003, medical: 0.002 }
      };

      const complexityMultipliers = {
        'simple': 1.0,
        'medium': 1.3,
        'complex': 1.6
      };

      const locationMultipliers = {
        'الرياض': 1.2, 'جدة': 1.1, 'الدمام': 1.0, 'مكة': 1.3,
        'المدينة': 1.2, 'تبوك': 0.9, 'أبها': 0.9, 'حائل': 0.8
      };

      const eventMult = eventMultipliers[info.eventType] || eventMultipliers['conference'];
      const complexMult = complexityMultipliers[info.complexity];
      const locationMult = locationMultipliers[info.location] || 1.0;

      // حسابات القوى العاملة
      const baseVolunteers = Math.ceil(info.attendees * eventMult.base * complexMult * locationMult);
      const supervisors = Math.ceil(baseVolunteers / 8);
      const coordinators = Math.ceil(supervisors / 3);
      const managers = Math.ceil(coordinators / 2);
      
      // فرق متخصصة
      const security = Math.ceil(info.attendees * eventMult.security * complexMult);
      const medical = Math.ceil(info.attendees * eventMult.medical);
      const reception = Math.ceil(info.buildings * 2) + Math.ceil(info.attendees / 200);
      const technical = Math.ceil(info.buildings + (info.area / 1000));
      const logistics = Math.ceil(baseVolunteers / 15);
      const media = info.attendees > 200 ? Math.ceil(info.attendees / 500) : 1;
      
      // حسابات التكلفة
      const totalStaff = baseVolunteers + supervisors + coordinators + managers + security + medical + reception + technical + logistics + media;
      const dailyCost = totalStaff * 180; // متوسط التكلفة للشخص الواحد
      const totalCost = dailyCost * info.duration;
      const equipmentCost = totalStaff * 120; // زي موحد ومعدات
      const finalCost = totalCost + equipmentCost;

      return `🎯 **التحليل الشامل لفعاليتك**\n\n` +
             `📋 **معلومات الفعالية:**\n` +
             `• النوع: ${getEventTypeArabic(info.eventType)}\n` +
             `• الحضور: ${info.attendees.toLocaleString()} شخص\n` +
             `• المدة: ${info.duration} أيام\n` +
             `• الموقع: ${info.location}\n` +
             `• المساحة: ${info.area.toLocaleString()} م²\n` +
             `• ساعات العمل: ${info.workHours} ساعة/يوم\n` +
             `• مستوى التعقيد: ${getComplexityArabic(info.complexity)}\n\n` +
             
             `👥 **القوى العاملة المطلوبة:**\n\n` +
             `**🔵 الفريق التطوعي:**\n` +
             `• المتطوعون الأساسيون: ${baseVolunteers} شخص\n` +
             `• المشرفون: ${supervisors} شخص\n` +
             `• المنسقون: ${coordinators} شخص\n` +
             `• المدراء: ${managers} شخص\n\n` +
             
             `**🔴 الفرق المتخصصة:**\n` +
             `• الأمن: ${security} شخص\n` +
             `• الطبي/الإسعاف: ${medical} شخص\n` +
             `• الاستقبال والتوجيه: ${reception} شخص\n` +
             `• الدعم التقني: ${technical} شخص\n` +
             `• اللوجستيات: ${logistics} شخص\n` +
             `• الإعلام والتسويق: ${media} شخص\n\n` +
             
             `📊 **الملخص:**\n` +
             `• **إجمالي القوى العاملة: ${totalStaff} شخص**\n` +
             `• نسبة الموظفين للحضور: ${((totalStaff/info.attendees)*100).toFixed(1)}%\n` +
             `• التغطية: ${Math.round(info.attendees/totalStaff)} حضور لكل موظف\n\n` +
             
             `💰 **التكلفة التقديرية:**\n` +
             `• التكلفة اليومية: ${dailyCost.toLocaleString()} ريال\n` +
             `• تكلفة المعدات والزي: ${equipmentCost.toLocaleString()} ريال\n` +
             `• **إجمالي التكلفة: ${finalCost.toLocaleString()} ريال**\n\n` +
             
             `📈 **توزيع القوى العاملة بالمناطق:**\n` +
             `${generateAreaDistribution(info, baseVolunteers, security, reception, technical)}\n\n` +
             
             `💡 **التوصيات:**\n` +
             `${generateRecommendations(info, totalStaff)}\n\n` +
             
             `✅ **هل تريد تعديل أي من هذه التقديرات؟**\n` +
             `يمكنك قول "غير عدد المتطوعين" أو "زود الأمن" أو "قلل التكلفة"`;
    }

    function getEventTypeArabic(type) {
      const types = {
        'conference': 'مؤتمر',
        'festival': 'مهرجان', 
        'exhibition': 'معرض',
        'workshop': 'ورشة عمل',
        'cultural': 'فعالية ثقافية'
      };
      return types[type] || 'فعالية';
    }

    function getComplexityArabic(complexity) {
      const levels = {
        'simple': 'بسيط',
        'medium': 'متوسط',
        'complex': 'معقد'
      };
      return levels[complexity] || 'متوسط';
    }

    function generateAreaDistribution(info, volunteers, security, reception, technical) {
      const areasPerBuilding = Math.ceil(volunteers / info.buildings);
      const securityPerBuilding = Math.ceil(security / info.buildings);
      
      let distribution = ``;
      for (let i = 1; i <= info.buildings; i++) {
        distribution += `**المبنى ${i}:** ${areasPerBuilding} متطوع، ${securityPerBuilding} أمن، ${Math.ceil(reception/info.buildings)} استقبال\n`;
      }
      return distribution;
    }

    function generateRecommendations(info, totalStaff) {
      let recommendations = [];
      
      recommendations.push(`ابدأ التوظيف قبل ${info.duration > 2 ? '6 أسابيع' : '4 أسابيع'} من الفعالية`);
      recommendations.push(`نظم دورة تدريبية لمدة ${info.complexity === 'complex' ? '3 أيام' : '2 يوم'}`);
      recommendations.push(`احتفظ بـ ${Math.ceil(totalStaff * 0.15)} شخص احتياطي (15%)`);
      
      if (info.attendees > 1000) {
        recommendations.push('استخدم تطبيق موبايل لإدارة الفرق');
      }
      
      if (info.duration > 3) {
        recommendations.push('خطط لنظام ورديات لتجنب الإرهاق');
      }
      
      if (info.workHours > 8) {
        recommendations.push('وفر مناطق راحة كافية للموظفين');
      }
      
      return recommendations.map(rec => `✅ ${rec}`).join('\n');
    }

    function handleModification(message) {
      const msg = message.toLowerCase();
      
      if (msg.includes('غير') || msg.includes('عدل') || msg.includes('زود') || msg.includes('قلل')) {
        return `بالطبع! يمكنني تعديل التقديرات. 🔧\n\nما الذي تريد تغييره تحديداً؟\n\n• عدد المتطوعين\n• فرق الأمن\n• الطاقم الطبي\n• التكلفة\n• توزيع الفرق\n• أي شيء آخر\n\nقل مثلاً: "زود عدد الأمن إلى 20" أو "قلل المتطوعين"`;
      }
      
      return `شكراً! هل تريد:\n\n🔄 **تعديل التقديرات** - لتغيير أي رقم\n📊 **تحليل إضافي** - لمعلومات أكثر تفصيلاً\n📋 **خطة جديدة** - لفعالية مختلفة\n💾 **حفظ التقرير** - للاستخدام لاحقاً\n\nماذا تختار؟`;
    }

    function appendMessage(sender, text) {
      const msg = document.createElement("div");
      msg.classList.add("message", sender);
      
      // تحويل النص ليدعم التنسيق
      const formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      
      msg.innerHTML = formattedText;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      return msg;
    }

    function showTypingIndicator() {
      typingIndicator.style.display = 'block';
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
    }

    function sendSuggestion(suggestion) {
      userInput.value = suggestion;
      sendMessage();
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !sendBtn.disabled) {
        sendMessage();
      }
    });

    // رسالة ترحيبية تلقائية
    setTimeout(() => {
      appendMessage("bot", "مرحباً! أنا هنا لمساعدتك في تقدير القوى العاملة التطوعية لفعاليتك. سأحلل المعلومات التي تعطيني إياها وأقدم لك تقريراً مفصلاً يشمل عدد المتطوعين والمنظمين والمشرفين والمسعفين وحتى التكلفة المتوقعة! 🎯\n\nما نوع الفعالية التي تخطط لها؟");
    }, 1000);
  </script>
</body>
</html>
